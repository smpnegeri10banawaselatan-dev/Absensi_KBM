<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Data Kehadiran Guru - Search & Pagination</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
  .navy { color: #001f3f; }
  .bg-navy { background-color: #001f3f; }
  .hover-bg-navy:hover { background-color: #003366; }
</style>
</head>
<body class="bg-gray-50 p-6">

<h2 class="text-center text-3xl font-bold mb-6 navy">Data Kehadiran Guru SMP Negeri 10 Banawa Selatan</h2>

<div class="mb-4 flex flex-col md:flex-row md:justify-between md:items-center space-y-4 md:space-y-0">
  <div>
    <button id="downloadExcel" class="bg-navy hover-bg-navy text-white px-4 py-2 rounded shadow-md mr-2">Download Excel</button>
    <button id="downloadPdf" class="bg-navy hover-bg-navy text-white px-4 py-2 rounded shadow-md">Download PDF</button>
  </div>
  <div>
    <input type="text" id="searchInput" placeholder="Cari Nama / Mapel / Topik..." class="border rounded px-4 py-2 w-full md:w-80">
  </div>
</div>

<div class="overflow-x-auto bg-white rounded shadow-md">
  <table id="dataTable" class="min-w-full table-auto border border-gray-300">
    <thead>
      <tr class="bg-navy text-white">
        <th class="border px-4 py-2 text-left">Nama Guru Mapel</th>
        <th class="border px-4 py-2 text-left">NIP</th>
        <th class="border px-4 py-2 text-left">Mapel</th>
        <th class="border px-4 py-2 text-left">Topik</th>
        <th class="border px-4 py-2 text-left">Jumlah Siswa Hadir</th>
        <th class="border px-4 py-2 text-center">Foto</th>
        <th class="border px-4 py-2 text-left">Latitude</th>
        <th class="border px-4 py-2 text-left">Longitude</th>
        <th class="border px-4 py-2 text-left">Timestamp</th>
      </tr>
    </thead>
    <tbody class="text-gray-700">
      <tr><td colspan="9" class="text-center py-8">Loading data...</td></tr>
    </tbody>
  </table>
</div>

<div id="pagination" class="flex justify-center mt-6 space-x-2"></div>

<script>
const csvUrl = 'https://docs.google.com/spreadsheets/d/13sHi-bSW-lkITVSrx2-YWtanLutcD_WNzTywo93C3Jo/export?format=csv&gid=1724845151';
let currentData = [];
let filteredData = [];
let currentPage = 1;
const itemsPerPage = 10;

function getDriveDirectLink(url) {
  if (!url) return '';
  if (url.includes('drive.google.com') && !url.includes('uc?export=view')) {
    const regex = /\/d\/([a-zA-Z0-9_-]+)/;
    const match = url.match(regex);
    if (match && match[1]) {
      return `https://drive.google.com/uc?export=view&id=${match[1]}`;
    }
  }
  return url;
}

function loadData() {
  fetch(csvUrl)
    .then(res => res.text())
    .then(csvText => {
      const results = Papa.parse(csvText, { header: true, skipEmptyLines: true });
      currentData = results.data;
      filteredData = currentData;
      currentPage = 1;
      renderTable();
    });
}

function renderTable() {
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML = '';
  if (filteredData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8">Tidak ada data</td></tr>';
    return;
  }

  const startIdx = (currentPage - 1) * itemsPerPage;
  const pageData = filteredData.slice(startIdx, startIdx + itemsPerPage);

  pageData.forEach(row => {
    const tr = document.createElement('tr');
    const fotoUrl = getDriveDirectLink(row['Foto']);
    tr.innerHTML = `
      <td class="border px-4 py-2">${row['Nama Guru Mapel'] || ''}</td>
      <td class="border px-4 py-2">${row['NIP'] || ''}</td>
      <td class="border px-4 py-2">${row['Mapel'] || ''}</td>
      <td class="border px-4 py-2">${row['Topik'] || ''}</td>
      <td class="border px-4 py-2">${row['Jumlah Siswa Hadir'] || ''}</td>
      <td class="border px-4 py-2 text-center">${fotoUrl ? `<a href="${fotoUrl}" target="_blank" class="text-navy"><i class="bi bi-camera text-xl"></i></a>` : ''}</td>
      <td class="border px-4 py-2">${row['Latitude'] || ''}</td>
      <td class="border px-4 py-2">${row['Longitude'] || ''}</td>
      <td class="border px-4 py-2">${row['Waktu'] || ''}</td>
    `;
    tbody.appendChild(tr);
  });

  renderPagination();
}

function renderPagination() {
  const totalPages = Math.ceil(filteredData.length / itemsPerPage);
  const paginationDiv = document.getElementById('pagination');
  paginationDiv.innerHTML = '';

  if (totalPages <= 1) return;

  const prevBtn = `<button class="px-3 py-1 bg-navy text-white rounded ${currentPage === 1 ? 'opacity-50' : ''}" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">Prev</button>`;
  const nextBtn = `<button class="px-3 py-1 bg-navy text-white rounded ${currentPage === totalPages ? 'opacity-50' : ''}" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">Next</button>`;

  paginationDiv.innerHTML += prevBtn;

  for (let i = 1; i <= totalPages; i++) {
    paginationDiv.innerHTML += `<button class="px-3 py-1 ${i === currentPage ? 'bg-blue-700 text-white' : 'bg-gray-200'} rounded" onclick="goToPage(${i})">${i}</button>`;
  }

  paginationDiv.innerHTML += nextBtn;
}

function goToPage(page) {
  currentPage = page;
  renderTable();
}

document.getElementById('searchInput').addEventListener('input', function() {
  const query = this.value.toLowerCase();
  filteredData = currentData.filter(row =>
    (row['Nama Guru Mapel'] || '').toLowerCase().includes(query) ||
    (row['Mapel'] || '').toLowerCase().includes(query) ||
    (row['Topik'] || '').toLowerCase().includes(query)
  );
  currentPage = 1;
  renderTable();
});

function downloadExcel() {
  if (!currentData.length) {
    alert('Data belum dimuat.');
    return;
  }

  const exportData = currentData.map(row => ({
    'Nama Guru Mapel': row['Nama Guru Mapel'] || '',
    'NIP': row['NIP'] || '',
    'Mapel': row['Mapel'] || '',
    'Topik': row['Topik'] || '',
    'Jumlah Siswa Hadir': row['Jumlah Siswa Hadir'] || '',
    'Foto URL': row['Foto'] || '',
    'Latitude': row['Latitude'] || '',
    'Longitude': row['Longitude'] || '',
    'Waktu': row['Waktu'] || '',
  }));

  const worksheet = XLSX.utils.json_to_sheet(exportData);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, 'KehadiranGuru');
  XLSX.writeFile(workbook, 'Data_Kehadiran_Guru.xlsx');
}

function downloadPdf() {
  if (!currentData.length) {
    alert('Data belum dimuat.');
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l', 'pt', 'a4');
  const columns = [
    'Nama Guru Mapel', 'NIP', 'Mapel', 'Topik', 'Jumlah Siswa Hadir', 'Latitude', 'Longitude', 'Waktu'
  ];

  const pdfData = currentData.map(row => [
    row['Nama Guru Mapel'] || '',
    row['NIP'] || '',
    row['Mapel'] || '',
    row['Topik'] || '',
    row['Jumlah Siswa Hadir'] || '',
    row['Latitude'] || '',
    row['Longitude'] || '',
    row['Waktu'] || '',
  ]);

  doc.autoTable({
    head: [columns],
    body: pdfData,
    startY: 20,
    styles: { fontSize: 8 },
    headStyles: { fillColor: [0, 31, 63] },
  });

  doc.save('Data_Kehadiran_Guru.pdf');
}

document.getElementById('downloadExcel').addEventListener('click', downloadExcel);
document.getElementById('downloadPdf').addEventListener('click', downloadPdf);

loadData();
</script>

</body>
</html>
